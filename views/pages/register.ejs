<%-
  include('../layouts/main', {
    body: `
      <div class="container text-center">
        <div id="entry" class="justify-content-md-center align-items-center row gx-4 col-md-8 col-xs-12">
          <form id="register-form" class="form-signin w-100 m-auto">
            <img
              class="mb-4"
              src="/src/public/images/logo.png"
              alt="Logo"
              width="100"
              height="100"
            />
            <h1 class="display-1 mb-3 fw-normal chem-font">ChemKey</h1>
            <p class="text-muted mb-4">Create your secure account</p>

            <!-- Mensagens de erro/sucesso -->
            <% if (error) { %>
              <div class="alert alert-danger" role="alert">
                <%= error %>
              </div>
            <% } %>

            <% if (message) { %>
              <div class="alert alert-success" role="alert">
                <%= message %>
              </div>
            <% } %>

            <div class="row g-3">
              <div class="col-12">
                <div class="form-floating">
                  <input type="text" name="name" id="name" class="form-control" required />
                  <label for="name">Full Name</label>
                </div>
              </div>

              <div class="col-12">
                <div class="form-floating">
                  <input type="email" name="email" id="email" class="form-control" required />
                  <label for="email">Email</label>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-floating">
                  <input type="password" name="password" id="password" class="form-control" required minlength="6" />
                  <label for="password">Password</label>
                </div>
                <div class="form-text text-start">
                  Minimum 6 characters
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-floating">
                  <input type="password" name="confirmPassword" id="confirmPassword" class="form-control" required />
                  <label for="confirmPassword">Confirm Password</label>
                </div>
              </div>
            </div>

            <div class="form-check text-start mt-3">
              <input class="form-check-input" type="checkbox" id="terms" required>
              <label class="form-check-label" for="terms">
                I agree to the <a href="#" class="text-decoration-none">Terms of Service</a> and
                <a href="#" class="text-decoration-none">Privacy Policy</a>
              </label>
            </div>

            <button class="btn btn-primary w-100 py-2 mt-3" type="submit">
              <span class="btn-text">Create Account</span>
              <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            </button>

            <div class="mt-3">
              <p class="text-muted">
                Already have an account?
                <a href="/login" class="text-decoration-none">Sign in here</a>
              </p>
            </div>

            <p class="mt-5 mb-3 text-body-secondary">© dev:Coelho est. 2025</p>
          </form>
        </div>
      </div>

      <script>
        // Password confirmation validation
        function validatePasswordMatch() {
          const password = document.getElementById('password');
          const confirmPassword = document.getElementById('confirmPassword');

          if (password.value !== confirmPassword.value) {
            confirmPassword.setCustomValidity('Passwords do not match');
            confirmPassword.classList.add('is-invalid');
          } else {
            confirmPassword.setCustomValidity('');
            confirmPassword.classList.remove('is-invalid');
            confirmPassword.classList.add('is-valid');
          }
        }

        // Add event listeners for password validation
        document.getElementById('password').addEventListener('input', validatePasswordMatch);
        document.getElementById('confirmPassword').addEventListener('input', validatePasswordMatch);

        // Register form handler
        document.getElementById('register-form').addEventListener('submit', async function(e) {
          e.preventDefault();

          const submitButton = this.querySelector('button[type="submit"]');
          const btnText = submitButton.querySelector('.btn-text');
          const spinner = submitButton.querySelector('.spinner-border');

          // Validate password match
          const password = document.getElementById('password').value;
          const confirmPassword = document.getElementById('confirmPassword').value;

          if (password !== confirmPassword) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger';
            alertDiv.textContent = 'As senhas não coincidem.';

            const existingAlert = this.querySelector('.alert');
            if (existingAlert) {
              existingAlert.remove();
            }

            this.querySelector('p.text-muted').insertAdjacentElement('afterend', alertDiv);
            return;
          }

          // Show loading state
          submitButton.disabled = true;
          btnText.textContent = 'Creating account...';
          spinner.classList.remove('d-none');

          try {
            const formData = new FormData(this);
            const data = {
              name: formData.get('name'),
              email: formData.get('email'),
              password: formData.get('password'),
              confirmPassword: formData.get('confirmPassword')
            };

            const response = await fetch('/auth/register', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
              // Show success message
              const alertDiv = document.createElement('div');
              alertDiv.className = 'alert alert-success';
              alertDiv.textContent = result.message;

              // Remove any existing alerts
              const existingAlert = this.querySelector('.alert');
              if (existingAlert) {
                existingAlert.remove();
              }

              // Insert new alert
              this.querySelector('p.text-muted').insertAdjacentElement('afterend', alertDiv);

              // Redirect after delay
              setTimeout(() => {
                window.location.href = result.redirectUrl || '/login';
              }, 2000);

            } else {
              // Show error message
              const alertDiv = document.createElement('div');
              alertDiv.className = 'alert alert-danger';
              alertDiv.textContent = result.error;

              // Remove any existing alerts
              const existingAlert = this.querySelector('.alert');
              if (existingAlert) {
                existingAlert.remove();
              }

              // Insert new alert
              this.querySelector('p.text-muted').insertAdjacentElement('afterend', alertDiv);
            }

          } catch (error) {
            console.error('Register error:', error);

            // Show generic error
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger';
            alertDiv.textContent = 'Erro de conexão. Tente novamente.';

            // Remove any existing alerts
            const existingAlert = this.querySelector('.alert');
            if (existingAlert) {
              existingAlert.remove();
            }

            // Insert new alert
            this.querySelector('p.text-muted').insertAdjacentElement('afterend', alertDiv);

          } finally {
            // Reset loading state
            submitButton.disabled = false;
            btnText.textContent = 'Create Account';
            spinner.classList.add('d-none');
          }
        });

        // Focus on first input
        document.getElementById('name').focus();
      </script>
    `,
    customCSS: ['/src/css/login.css'],
    bodyClass: 'd-flex align-items-center py-4 bg-body-tertiary',
    showNavbar: false,
    showFooter: false,
    currentPage: 'register'
  })
%>
